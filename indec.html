<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi App de Gimnasio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7e1e1; /* Rosa pastel */
            color: #4b5563;
        }

        .main-title {
            font-size: 2.5rem; /* Un tamaño de letra grande */
            font-weight: 800; /* Extra bold */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1); /* Sombra sutil para que resalte */
        }
        .sidebar-item {
            transition: background-color 0.3s ease;
        }
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .container {
            max-width: 100vw;
            overflow-x: hidden;
        }
        .hidden-view {
            display: none;
        }

        /* Estilos para que los modales tengan scroll */
        .scrollable-modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .daily-progress-bar-container {
            display: flex;
            height: 1rem;
            border-radius: 9999px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .daily-progress-bar-completed {
            background-color: #68d391; /* green-400 */
            transition: width 0.5s ease-in-out;
        }
        .daily-progress-bar-missed {
            background-color: #fc8181; /* red-400 */
            transition: width 0.5s ease-in-out;
        }

        /* Modal para imagen ampliada */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            color: #333;
        }
        .modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Estilos responsivos para el sidebar */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            z-index: 50;
            width: 100%;
        }
        .sidebar.active {
            transform: translateX(0);
        }
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
                width: 16rem; /* 256px */
            }
        }

        /* Mobile navigation bar */
        @media (max-width: 767px) {
            .app-view {
                padding-bottom: 80px; /* Space for the fixed bottom bar */
            }
            .bottom-nav {
                display: flex;
            }
        }
        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
        }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">
    <!-- Botón para abrir el menú en móviles -->
    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 rounded-full bg-rose-400 text-white shadow-lg focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>
    
    <!-- Sidebar con diseño responsivo -->
    <div id="sidebar" class="sidebar fixed md:relative h-full md:h-auto bg-rose-300 text-white flex flex-col p-4 space-y-4 shadow-xl">
        <div class="text-center text-xl font-bold mb-8 hidden md:block">Gym App</div>
        <div class="sidebar-item cursor-pointer flex items-center p-3 rounded-xl bg-orange-300 shadow-md transition-transform transform hover:scale-105" onclick="changeView('miInformacion')">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span class="hidden md:inline">Mi Información</span>
        </div>
        <div class="sidebar-item cursor-pointer flex items-center p-3 rounded-xl bg-green-300 shadow-md transition-transform transform hover:scale-105" onclick="changeView('calendario')">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span class="hidden md:inline">Calendario</span>
        </div>
        <div class="sidebar-item cursor-pointer flex items-center p-3 rounded-xl bg-blue-300 shadow-md transition-transform transform hover:scale-105" onclick="changeView('miSemana')">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
            <span class="hidden md:inline">Mi Semana</span>
        </div>
        <div class="sidebar-item cursor-pointer flex items-center p-3 rounded-xl bg-purple-300 shadow-md transition-transform transform hover:scale-105" onclick="changeView('historial')">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-4 8l-2-2m0 0l-2 2m2-2V5m7 6v2m0 4v2"></path></svg>
            <span class="hidden md:inline">Historial</span>
        </div>
    </div>

    <div class="flex-grow p-4 md:p-8 container mx-auto">
        <!-- Contenedor para los modales -->
        <div id="modal-container" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50 p-4"></div>
        <div id="exercise-modal-container" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50 p-4"></div>
        <div id="image-modal" class="modal-overlay" onclick="closeModal('image-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal('image-modal')">&times;</button>
                <img id="modal-image-src" class="modal-image" src="" alt="Imagen ampliada">
            </div>
        </div>
        <div id="missed-exercises-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50 p-4"></div>

        <!-- Vistas de la aplicación -->
        <div id="miInformacion" class="app-view">
            <h2 class="main-title text-center text-rose-400 mb-8">Mi Información</h2>
            <div class="bg-white p-6 rounded-3xl shadow-lg max-w-lg mx-auto">
                <div class="space-y-4">
                    <label class="block">
                        <span class="text-sm font-semibold">Peso (kg):</span>
                        <input type="number" id="peso" class="mt-1 p-2 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-rose-200 bg-gray-100 cursor-not-allowed" placeholder="Ej: 70" readonly>
                    </label>
                    <label class="block">
                        <span class="text-sm font-semibold">Altura (cm):</span>
                        <input type="number" id="altura" class="mt-1 p-2 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-rose-200 bg-gray-100 cursor-not-allowed" placeholder="Ej: 170" readonly>
                    </label>
                    <label class="block">
                        <span class="text-sm font-semibold">Edad:</span>
                        <input type="number" id="edad" class="mt-1 p-2 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-rose-200 bg-gray-100 cursor-not-allowed" placeholder="Ej: 30" readonly>
                    </label>
                    <label class="block">
                        <span class="text-sm font-semibold">Género:</span>
                        <select id="genero" class="mt-1 p-2 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-rose-200 bg-gray-100 cursor-not-allowed" disabled>
                            <option value="">Seleccionar</option>
                            <option value="femenino">Femenino</option>
                            <option value="masculino">Masculino</option>
                            <option value="otro">Otro</option>
                        </select>
                    </label>
                    <div id="info-actions" class="flex justify-end space-x-2">
                        <button id="edit-info-btn" class="bg-blue-400 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105">Editar</button>
                        <button id="save-info-btn" class="bg-rose-400 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 hidden">Guardar</button>
                    </div>
                </div>
                <div id="resultado-imc" class="mt-6 text-center text-lg font-semibold p-4 rounded-xl bg-rose-100 hidden"></div>
            </div>
        </div>

        <div id="calendario" class="app-view hidden-view">
            <h2 class="main-title text-center text-indigo-400 mb-8">Mi Calendario de Gimnasio</h2>
            <div class="bg-white p-6 rounded-3xl shadow-lg max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonth" class="bg-indigo-300 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105"><</button>
                    <h3 id="monthYear" class="text-xl font-semibold"></h3>
                    <button id="nextMonth" class="bg-indigo-300 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105">></button>
                </div>
                <!-- Grid para los días de la semana (ajustado para móviles) -->
                <div class="grid grid-cols-7 gap-2 text-center text-sm font-medium text-gray-500">
                    <div class="text-xs sm:text-sm">Lun</div>
                    <div class="text-xs sm:text-sm">Mar</div>
                    <div class="text-xs sm:text-sm">Mié</div>
                    <div class="text-xs sm:text-sm">Jue</div>
                    <div class="text-xs sm:text-sm">Vie</div>
                    <div class="text-xs sm:text-sm">Sáb</div>
                    <div class="text-xs sm:text-sm">Dom</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 mt-2"></div>
                <div id="calendar-counts" class="mt-4 p-4 rounded-xl bg-indigo-100 text-indigo-800 font-semibold text-center"></div>
            </div>
        </div>

        <div id="miSemana" class="app-view hidden-view">
            <h2 class="main-title text-center text-teal-400 mb-8">Mi Semana de Entrenamiento</h2>
            <div class="mt-4 p-4 rounded-xl bg-teal-100 text-teal-800 font-semibold text-center hidden" id="weekly-progress-container">
                <h4 class="font-bold">Progreso Semanal</h4>
                <div id="weekly-progress-bar-container" class="w-full bg-gray-200 rounded-full h-4 mt-2 overflow-hidden">
                    <div id="weekly-progress-bar" class="bg-teal-400 h-4 rounded-full transition-all duration-500" style="width: 0%;"></div>
                </div>
                <p id="weekly-progress-message" class="mt-2 text-sm"></p>
            </div>

            <div class="flex justify-center space-x-4 mt-8">
                <button class="bg-gray-400 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105" onclick="showResetSummary()">Restablecer Semana</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mt-8">
                <div class="day-card bg-white p-6 rounded-3xl shadow-lg text-center transition-transform transform hover:scale-105 cursor-pointer bg-teal-200 text-teal-800" onclick="showDay('Lunes')">
                    <h3 class="text-xl font-bold">Lunes</h3>
                </div>
                <div class="day-card bg-white p-6 rounded-3xl shadow-lg text-center transition-transform transform hover:scale-105 cursor-pointer bg-teal-300 text-teal-800" onclick="showDay('Martes')">
                    <h3 class="text-xl font-bold">Martes</h3>
                </div>
                <div class="day-card bg-white p-6 rounded-3xl shadow-lg text-center transition-transform transform hover:scale-105 cursor-pointer bg-teal-400 text-teal-800" onclick="showDay('Miércoles')">
                    <h3 class="text-xl font-bold">Miércoles</h3>
                </div>
                <div class="day-card bg-white p-6 rounded-3xl shadow-lg text-center transition-transform transform hover:scale-105 cursor-pointer bg-teal-500 text-teal-800" onclick="showDay('Jueves')">
                    <h3 class="text-xl font-bold">Jueves</h3>
                </div>
                <div class="day-card bg-white p-6 rounded-3xl shadow-lg text-center transition-transform transform hover:scale-105 cursor-pointer bg-teal-600 text-teal-800" onclick="showDay('Viernes')">
                    <h3 class="text-xl font-bold">Viernes</h3>
                </div>
            </div>
        </div>

        <div id="day-view" class="app-view hidden-view">
            <div class="flex justify-around mb-4 flex-wrap">
                <button class="bg-orange-300 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 text-orange-800 mb-2" onclick="showDay('Lunes')">Lunes</button>
                <button class="bg-green-300 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 text-green-800 mb-2" onclick="showDay('Martes')">Martes</button>
                <button class="bg-blue-300 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 text-blue-800 mb-2" onclick="showDay('Miércoles')">Miércoles</button>
                <button class="bg-purple-300 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 text-purple-800 mb-2" onclick="showDay('Jueves')">Jueves</button>
                <button class="bg-rose-300 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 text-rose-800 mb-2" onclick="showDay('Viernes')">Viernes</button>
            </div>
            <h2 id="day-title" class="main-title text-center text-gray-700 mb-8"></h2>
            
            <!-- Daily Progress Bar -->
            <div id="daily-progress-container" class="mt-4 mb-8 p-4 rounded-xl bg-gray-100 text-gray-800 font-semibold text-center">
                <h4 class="font-bold">Progreso Diario</h4>
                <div id="daily-progress-bar-container" class="daily-progress-bar-container mt-2">
                    <div id="daily-progress-bar-completed" class="daily-progress-bar-completed"></div>
                    <div id="daily-progress-bar-missed" class="daily-progress-bar-missed"></div>
                </div>
                <p id="daily-progress-message" class="mt-2 text-sm"></p>
            </div>

            <div id="exercise-list" class="space-y-4"></div>
            <div class="flex justify-center mt-4">
                <button class="bg-blue-400 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105" onclick="showAddExerciseModal()">Agregar Ejercicio</button>
            </div>
        </div>

        <div id="historial" class="app-view hidden-view">
            <h2 class="main-title text-center text-rose-400 mb-8">Historial de Entrenamientos</h2>
            <div id="historial-list" class="space-y-4"></div>
        </div>
    </div>

    <!-- Mobile Navigation Bar -->
    <div class="bottom-nav fixed bottom-0 left-0 right-0 bg-rose-300 text-white p-4 shadow-xl z-50 rounded-t-3xl justify-around items-center">
        <button class="flex flex-col items-center justify-center p-2 rounded-xl transition-transform transform hover:scale-110" onclick="changeView('miInformacion')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span class="text-xs mt-1">Info</span>
        </button>
        <button class="flex flex-col items-center justify-center p-2 rounded-xl transition-transform transform hover:scale-110" onclick="changeView('calendario')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span class="text-xs mt-1">Cal</span>
        </button>
        <button class="flex flex-col items-center justify-center p-2 rounded-xl transition-transform transform hover:scale-110" onclick="changeView('miSemana')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
            <span class="text-xs mt-1">Semana</span>
        </button>
        <button class="flex flex-col items-center justify-center p-2 rounded-xl transition-transform transform hover:scale-110" onclick="changeView('historial')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-4 8l-2-2m0 0l-2 2m2-2V5m7 6v2m0 4v2"></path></svg>
            <span class="text-xs mt-1">Hist</span>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        let userData;
        let currentDay;
        const weekDays = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];

        // Make functions globally accessible
        window.changeView = changeView;
        window.showDay = showDay;
        window.prevMonth = prevMonth;
        window.nextMonth = nextMonth;
        window.showAddExerciseModal = showAddExerciseModal;
        window.saveExercise = saveExercise;
        window.toggleExerciseStatus = toggleExerciseStatus;
        window.showEditExerciseModal = showEditExerciseModal;
        window.showConfirmationModal = showConfirmationModal;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.deleteExercise = deleteExercise;
        window.deleteHistoryItem = deleteHistoryItem;
        window.showResetSummary = showResetSummary;
        window.resetWeek = resetWeek;

        // Data structure
        const defaultExercises = {
            "Lunes": [
                { name: "Hip thrust", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio para fortalecer glúteos y femorales.", howTo: "Apoya la parte superior de la espalda en un banco, con los pies en el suelo. Coloca la barra sobre las caderas y empuja hacia arriba, contrayendo los glúteos.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Hip+Thrust" },
                { name: "Peso muerto", series: 3, reps: 10, weight: 0, status: 0, description: "Ejercicio para la cadena posterior: femorales, glúteos y espalda baja.", howTo: "De pie, con los pies al ancho de los hombros, levanta la barra manteniendo la espalda recta.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Peso+Muerto" },
                { name: "Sentadilla búlgara", series: 4, reps: 10, weight: 0, status: 0, description: "Ejercicio que fortalece cuádriceps y glúteos.", howTo: "De pie, apoya el empeine de una pierna sobre un banco. Flexiona la rodilla de la pierna de apoyo hasta que el muslo quede paralelo al suelo.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Sentadilla+Bulgara" },
                { name: "Patada en polea", series: 3, reps: 10, weight: 0, status: 0, description: "Ejercicio de aislamiento para los glúteos.", howTo: "En la máquina de poleas, sujeta la mancuerna en la pierna y extiende la pierna hacia atrás, contrayendo el glúteo.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Patada+en+Polea" },
                { name: "Femoral tumbado", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio de aislamiento para los femorales.", howTo: "Tumbado boca abajo en la máquina, flexiona las rodillas para acercar los talones a los glúteos.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Femoral+Tumbado" }
            ],
            "Martes": [
                { name: "Jalón abierto", series: 3, reps: 12, weight: 0, status: 0, description: "Ejercicio para la amplitud de la espalda.", howTo: "Siéntate en la máquina de jalón. Sujeta la barra con un agarre abierto y tira hacia abajo, contrayendo los dorsales.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Jalon+Abierto" },
                { name: "Remo en máquina", series: 3, reps: 12, weight: 0, status: 0, description: "Ejercicio para la densidad de la espalda.", howTo: "Siéntate en la máquina de remo. Tira de la empuñadura hacia el abdomen, manteniendo la espalda recta.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Remo+en+Maquina" },
                { name: "Dominadas en máquina", series: 3, reps: 10, weight: 0, status: 0, description: "Ejercicio compuesto para la espalda y bíceps.", howTo: "Utiliza la máquina asistida. Sube y baja con control, utilizando la fuerza de la espalda.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Dominadas+en+Maquina" },
                { name: "Curl de bíceps con barra", series: 3, reps: 10, weight: 0, status: 0, description: "Ejercicio de aislamiento para los bíceps.", howTo: "De pie, sujeta la barra y flexiona los codos para subirla hasta los hombros.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Curl+de+Biceps" },
                { name: "Martillos", series: 3, reps: 10, weight: 0, status: 0, description: "Ejercicio para el braquial y bíceps.", howTo: "De pie, sujeta las mancuernas con las palmas de las manos mirando una hacia la otra y sube los brazos.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Martillos" },
                { name: "Cardio", series: 1, reps: 15, weight: 0, status: 0, description: "Cardio de 15 a 20 minutos de escaladora o caminadora.", howTo: "Realiza el ejercicio en la máquina de tu elección por el tiempo indicado.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Cardio" }
            ],
            "Miércoles": [
                { name: "Sentadilla en Smith", series: 4, reps: 10, weight: 0, status: 0, description: "Ejercicio para los cuádriceps.", howTo: "Colócate en la máquina Smith. Baja con la barra sobre los hombros, manteniendo la espalda recta.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Sentadilla+Smith" },
                { name: "Prensa", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio para los cuádriceps y glúteos.", howTo: "Siéntate en la máquina de prensa. Empuja la plataforma con los pies, estirando las piernas.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Prensa" },
                { name: "Extensión de cuádriceps", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio de aislamiento para los cuádriceps.", howTo: "Siéntate en la máquina. Levanta el peso extendiendo las rodillas.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Extension+Cuadriceps" },
                { name: "Máquina de abductores", series: 4, reps: 10, weight: 0, status: 0, description: "Ejercicio de aislamiento para los abductores.", howTo: "Siéntate en la máquina. Abre las piernas contra la resistencia.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Maquina+Abductores" },
                { name: "Pantorrilla en Smith", series: 4, reps: 12, weight: 0, status: 0, description: "Ejercicio para las pantorrillas.", howTo: "En la máquina Smith, eleva los talones para levantar el peso.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Pantorrilla+Smith" }
            ],
            "Jueves": [
                { name: "Press militar", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio para los hombros.", howTo: "De pie o sentado, sujeta la barra. Empuja la barra hacia arriba sobre la cabeza.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Press+Militar" },
                { name: "Elevaciones laterales", series: 3, reps: 10, weight: 0, status: 0, description: "Ejercicio de aislamiento para los deltoides laterales.", howTo: "De pie, con las mancuernas en las manos. Levanta los brazos hacia los lados hasta la altura de los hombros.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Elevaciones+Laterales" },
                { name: "Elevaciones frontales", series: 3, reps: 10, weight: 0, status: 0, description: "Ejercicio para la parte frontal del hombro.", howTo: "En la máquina de poleas, con un agarre en una mano, eleva el brazo hacia adelante.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Elevaciones+Frontales" },
                { name: "Copa tríceps con mancuerna", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio para los tríceps.", howTo: "De pie, sujeta una mancuerna con ambas manos por detrás de la cabeza y extiende los brazos hacia arriba.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Copa+Triceps" },
                { name: "Extensión de tríceps con cuerda", series: 3, reps: 8, weight: 0, status: 0, description: "Ejercicio de aislamiento para los tríceps.", howTo: "En la máquina de poleas, sujeta la cuerda y empuja hacia abajo, estirando los codos.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Extension+Triceps" },
                { name: "Extensión de tríceps en polea a una mano", series: 2, reps: 12, weight: 0, status: 0, description: "Ejercicio de aislamiento para los tríceps.", howTo: "En la máquina de poleas, sujeta el agarre en una mano y extiende el codo hacia abajo.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Extension+Triceps" },
                { name: "Cardio", series: 1, reps: 15, weight: 0, status: 0, description: "Cardio de 15 a 20 minutos de escaladora o caminadora.", howTo: "Realiza el ejercicio en la máquina de tu elección por el tiempo indicado.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Cardio" }
            ],
            "Viernes": [
                { name: "Hip thrust", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio para glúteos y femorales.", howTo: "Apoya la parte superior de la espalda en un banco. Empuja la barra con las caderas.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Hip+Thrust" },
                { name: "Peso muerto rumano", series: 3, reps: 10, weight: 0, status: 0, description: "Ejercicio para los femorales y glúteos.", howTo: "De pie, con la barra. Flexiona la cadera manteniendo las piernas casi estiradas.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Peso+Muerto+Rumano" },
                { name: "Prensa", series: 4, reps: 10, weight: 0, status: 0, description: "Ejercicio para cuádriceps y glúteos.", howTo: "Siéntate en la máquina y empuja el peso con los pies.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Prensa" },
                { name: "Extensión de cuádriceps", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio de aislamiento para los cuádriceps.", howTo: "Siéntate en la máquina y extiende las rodillas.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Extension+Cuadriceps" },
                { name: "Sentadilla en Smith", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio para los cuádriceps.", howTo: "Colócate en la máquina Smith y baja con la barra sobre los hombros.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Sentadilla+Smith" },
                { name: "Máquina de abductores", series: 4, reps: 8, weight: 0, status: 0, description: "Ejercicio para los abductores.", howTo: "Siéntate en la máquina y abre las piernas.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Maquina+Abductores" },
                { name: "Pantorrillas", series: 4, reps: 12, weight: 0, status: 0, description: "Ejercicio para las pantorrillas.", howTo: "De pie, levanta los talones para levantar el peso.", image: "https://placehold.co/800x600/1e40af/ffffff?text=Pantorrillas" }
            ]
        };

        // Initialize Firebase and Auth
        async function initializeAppAndAuth() {
            try {
                if (!firebaseConfig.projectId) {
                    throw new Error('"projectId" not provided in firebaseConfig.');
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase inicializado correctamente.");

                // Use the provided custom auth token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log(`Usuario autenticado con ID: ${userId}`);
                        // Start listeners for user data after successful auth
                        startFirestoreListeners();
                    } else {
                        console.log("No hay usuario autenticado.");
                        userId = null;
                        userData = null;
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error.message);
            }
        }

        // Firestore listeners
        function startFirestoreListeners() {
            if (!userId) {
                console.error("Firebase no está inicializado. Saliendo de la autenticación.");
                return;
            }

            // User data listener
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/privateData`, "data");
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    userData = docSnap.data();
                } else {
                    userData = {
                        profile: {},
                        calendar: {},
                        exercises: defaultExercises,
                        history: {}
                    };
                    setDoc(userDocRef, userData).catch(error => console.error("Error al crear el documento inicial:", error));
                }
                updateUI();
            }, (error) => {
                console.error("Error al escuchar los datos del usuario:", error);
            });
        }

        // General UI update
        function updateUI() {
            if (!userData) return;
            renderProfile();
            renderCalendar();
            renderHistory();
            calculateWeeklyProgress();
            if (currentDay) {
                showDay(currentDay);
            }
        }

        // View management
        function changeView(viewId) {
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.add('hidden-view');
            });
            document.getElementById(viewId).classList.remove('hidden-view');
            
            // Cerrar el sidebar en móviles después de cambiar de vista
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth < 768) {
                sidebar.classList.remove('active');
            }

            if (viewId === 'historial') {
                renderHistory();
            } else if (viewId === 'miSemana') {
                renderWeek();
            }
        }

        // My Info View
        function renderProfile() {
            const profile = userData?.profile || {};
            document.getElementById('peso').value = profile.peso || '';
            document.getElementById('altura').value = profile.altura || '';
            document.getElementById('edad').value = profile.edad || '';
            document.getElementById('genero').value = profile.genero || '';

            const imcResultDiv = document.getElementById('resultado-imc');
            if (profile.imc) {
                let clasificacion = "";
                if (profile.imc < 18.5) {
                    clasificacion = "Peso insuficiente";
                } else if (profile.imc >= 18.5 && profile.imc <= 24.9) {
                    clasificacion = "Peso normal (saludable)";
                } else if (profile.imc >= 25.0 && profile.imc <= 29.9) {
                    clasificacion = "Sobrepeso";
                } else {
                    clasificacion = "Obesidad";
                }
                
                let pesoMensaje = '';
                if (profile.pesoDiferencia !== null) {
                    if (profile.imc < 18.5) {
                        pesoMensaje = `<br>Necesitas ganar <b>${profile.pesoDiferencia.toFixed(2)} kg</b> para entrar en el rango de peso normal.`;
                    } else if (profile.imc > 24.9) {
                        pesoMensaje = `<br>Necesitas perder <b>${profile.pesoDiferencia.toFixed(2)} kg</b> para entrar en el rango de peso normal.`;
                    }
                }

                imcResultDiv.innerHTML = `
                    Tu IMC es <b>${profile.imc.toFixed(2)}</b>.
                    <br>Clasificación: <b>${clasificacion}</b>.
                    ${pesoMensaje}
                `;
                imcResultDiv.classList.remove('hidden');
            } else {
                imcResultDiv.classList.add('hidden');
            }

            document.getElementById('peso').readOnly = true;
            document.getElementById('altura').readOnly = true;
            document.getElementById('edad').readOnly = true;
            document.getElementById('genero').disabled = true;
            document.getElementById('edit-info-btn').classList.remove('hidden');
            document.getElementById('save-info-btn').classList.add('hidden');
        }

        document.getElementById('edit-info-btn').addEventListener('click', () => {
            document.getElementById('peso').readOnly = false;
            document.getElementById('altura').readOnly = false;
            document.getElementById('edad').readOnly = false;
            document.getElementById('genero').disabled = false;
            document.getElementById('peso').classList.remove('cursor-not-allowed', 'bg-gray-100');
            document.getElementById('altura').classList.remove('cursor-not-allowed', 'bg-gray-100');
            document.getElementById('edad').classList.remove('cursor-not-allowed', 'bg-gray-100');
            document.getElementById('genero').classList.remove('cursor-not-allowed', 'bg-gray-100');
            document.getElementById('edit-info-btn').classList.add('hidden');
            document.getElementById('save-info-btn').classList.remove('hidden');
        });

        document.getElementById('save-info-btn').addEventListener('click', async () => {
            const peso = parseFloat(document.getElementById('peso').value);
            const altura = parseFloat(document.getElementById('altura').value);
            const edad = parseInt(document.getElementById('edad').value, 10);
            const genero = document.getElementById('genero').value;

            if (isNaN(peso) || isNaN(altura) || isNaN(edad)) {
                alert("Por favor, ingresa valores válidos para peso, altura y edad.");
                return;
            }

            const alturaM = altura / 100;
            const imc = peso / (alturaM * alturaM);

            let pesoDiferencia = null;
            const minNormalWeight = 18.5 * (alturaM * alturaM);
            const maxNormalWeight = 24.9 * (alturaM * alturaM);

            if (imc < 18.5) {
                pesoDiferencia = minNormalWeight - peso;
            } else if (imc > 24.9) {
                pesoDiferencia = peso - maxNormalWeight;
            }

            userData.profile = {
                peso: peso,
                altura: altura,
                edad: edad,
                genero: genero,
                imc: imc,
                pesoDiferencia: pesoDiferencia
            };
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/privateData`, "data");
            await setDoc(userDocRef, { profile: userData.profile }, { merge: true });
            renderProfile();
        });


        // Calendar View
        let currentDate = new Date();
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            const monthYear = document.getElementById('monthYear');

            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            monthYear.textContent = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' });

            const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('p-2', 'rounded-lg');
                calendarGrid.appendChild(emptyCell);
            }

            let attendanceCount = 0;
            let absenceCount = 0;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${month + 1}-${day}`;
                const dayDiv = document.createElement('div');
                const status = userData?.calendar?.[dateKey] || 0; // 0: none, 1: missed, 2: attended
                dayDiv.classList.add('p-2', 'text-center', 'rounded-lg', 'font-semibold', 'cursor-pointer', 'transition-colors', 'duration-200');

                dayDiv.textContent = day;

                if (status === 1) { // Missed
                    dayDiv.classList.add('bg-red-300', 'text-red-800');
                    dayDiv.innerHTML += '<br><span class="text-xl">❌</span>';
                    absenceCount++;
                } else if (status === 2) { // Attended
                    dayDiv.classList.add('bg-green-300', 'text-green-800');
                    dayDiv.innerHTML += '<br><span class="text-xl">✔️</span>';
                    attendanceCount++;
                } else {
                    dayDiv.classList.add('bg-gray-200', 'hover:bg-gray-300');
                }

                dayDiv.addEventListener('click', async (event) => {
                    event.stopPropagation();
                    let newStatus = 0;
                    if (status === 0) {
                        newStatus = 1; // Missed
                    } else if (status === 1) {
                        newStatus = 2; // Attended
                    } else if (status === 2) {
                        newStatus = 0; // Reset
                    }
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/privateData`, "data");
                    const calendarUpdate = { [`calendar.${dateKey}`]: newStatus };
                    await updateDoc(userDocRef, calendarUpdate);
                });

                calendarGrid.appendChild(dayDiv);
            }

            document.getElementById('calendar-counts').textContent = `Asistencias: ${attendanceCount} | Faltas: ${absenceCount}`;
        }
        
        // Navigation for calendar
        window.prevMonth = () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        };

        window.nextMonth = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        };

        // Week View
        function renderWeek() {
            // This function is just to show the Week view, the day rendering is done in showDay
        }

        // Day View
        function showDay(day) {
            currentDay = day;
            const exercises = userData?.exercises?.[day] || [];
            document.getElementById('day-title').textContent = day;
            const exerciseListDiv = document.getElementById('exercise-list');
            exerciseListDiv.innerHTML = '';
            
            let completedCount = 0;
            let missedCount = 0;
            const totalCount = exercises.length;
            
            exercises.forEach(exercise => {
                if (exercise.status === 1) {
                    missedCount++;
                } else if (exercise.status === 2) {
                    completedCount++;
                }
            });

            // Update daily progress bar
            const completedBar = document.getElementById('daily-progress-bar-completed');
            const missedBar = document.getElementById('daily-progress-bar-missed');
            const dailyProgressMessage = document.getElementById('daily-progress-message');

            const completedProgress = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
            const missedProgress = totalCount > 0 ? (missedCount / totalCount) * 100 : 0;
            
            completedBar.style.width = `${completedProgress}%`;
            missedBar.style.width = `${missedProgress}%`;

            dailyProgressMessage.textContent = `Has completado ${completedCount} y faltado a ${missedCount} de ${totalCount} ejercicios.`;

            exercises.forEach((exercise, index) => {
                const card = document.createElement('div');
                let cardColor, statusIcon = '';

                if (exercise.status === 1) { // Missed
                    cardColor = 'bg-red-300';
                    statusIcon = '❌';
                } else if (exercise.status === 2) { // Attended
                    cardColor = 'bg-green-300';
                    statusIcon = '✔️';
                } else { // Not done
                    cardColor = 'bg-white';
                }

                card.className = `p-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 ${cardColor} flex flex-col md:flex-row items-center md:items-start gap-6`;

                const imageHtml = exercise.image ? `
                    <div class="relative w-24 h-24 sm:w-32 sm:h-32 rounded-lg overflow-hidden cursor-pointer flex-shrink-0" onclick="openModal('${exercise.image}')">
                        <img class="object-cover w-full h-full" src="${exercise.image}" alt="Imagen del ejercicio">
                        <div class="absolute inset-0 flex justify-center items-center bg-black bg-opacity-50 opacity-0 hover:opacity-100 transition-opacity duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                            </svg>
                        </div>
                    </div>
                ` : `<div class="w-24 h-24 sm:w-32 sm:h-32 rounded-lg bg-gray-200 flex items-center justify-center text-center text-sm text-gray-500 flex-shrink-0">Sin imagen</div>`;

                card.innerHTML = `
                    ${imageHtml}
                    <div class="flex-1 w-full md:w-auto">
                        <div class="flex items-center justify-between">
                            <h4 class="text-lg font-bold text-gray-800">${exercise.name}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl">${statusIcon}</span>
                                <button onclick="showEditExerciseModal('${day}', ${index})" class="bg-gray-300 text-gray-700 py-1 px-3 rounded-full hover:bg-gray-400 transition-colors">Editar</button>
                            </div>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <p><strong>Series:</strong> ${exercise.series}</p>
                            <p><strong>Repeticiones:</strong> ${exercise.reps}</p>
                            <p><strong>Peso:</strong> ${exercise.weight || 0} kg</p>
                            <p><strong>Qué trabaja:</strong> ${exercise.description}</p>
                            <p><strong>Cómo hacerlo:</strong> ${exercise.howTo}</p>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <p class="text-sm font-semibold">Toca para marcar:</p>
                            <button onclick="toggleExerciseStatus('${day}', ${index})" class="text-white py-1 px-3 rounded-full shadow-md bg-blue-400 hover:bg-blue-500 transition-colors">Marcar</button>
                        </div>
                    </div>
                `;
                exerciseListDiv.appendChild(card);
            });
            
            changeView('day-view');
        }

        // Exercise status management
        async function toggleExerciseStatus(day, index) {
            const exercise = userData.exercises[day][index];
            const oldStatus = exercise.status;
            const newStatus = (oldStatus + 1) % 3; // 0 -> 1 -> 2 -> 0

            exercise.status = newStatus;
            
            // Update history based on new status
            if (newStatus === 2) { // If completed, add to history
                const historyId = `${day}-${Date.now()}`;
                userData.history[historyId] = {
                    ...exercise,
                    day: day,
                    date: new Date().toISOString()
                };
            } else if (oldStatus === 2) { // If it was completed before and now it's not, remove from history
                const historyKeys = Object.keys(userData.history || {});
                const keyToRemove = historyKeys.find(key => userData.history[key].day === day && userData.history[key].name === exercise.name);
                if (keyToRemove) {
                    delete userData.history[keyToRemove];
                }
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/privateData`, "data");
            await updateDoc(userDocRef, {
                exercises: userData.exercises,
                history: userData.history
            });

            // Re-render the current day to reflect the change
            showDay(day);

            // Check for weekly completion
            if (day === "Viernes") {
                const totalExercises = userData.exercises[day].length;
                const completedOrMissedCount = userData.exercises[day].filter(e => e.status !== 0).length;
                
                // If all exercises for Friday are marked
                if (totalExercises === completedOrMissedCount) {
                    const totalWeeklyExercises = Object.values(userData.exercises).flat().length;
                    const completedWeeklyExercises = Object.values(userData.exercises).flat().filter(e => e.status === 2).length;
                    const missedWeeklyExercises = Object.values(userData.exercises).flat().filter(e => e.status === 1).length;
                    const weeklyProgress = (completedWeeklyExercises + missedWeeklyExercises) / totalWeeklyExercises * 100;
                    
                    let message = `¡Felicidades! Has completado el ${weeklyProgress.toFixed(0)}% de tu semana de entrenamiento.`;
                    message += `\n\nHas completado ${completedWeeklyExercises} ejercicios y faltado a ${missedWeeklyExercises}.`;
                    message += `\n\n¿Quieres restablecer las marcas de la semana para empezar de nuevo?`;
                }
            }
        }
        
        async function resetWeek() {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/privateData`, "data");
            const newExercises = JSON.parse(JSON.stringify(userData.exercises)); // Deep copy
            weekDays.forEach(day => {
                newExercises[day].forEach(exercise => {
                    exercise.status = 0;
                });
            });
            await updateDoc(userDocRef, { exercises: newExercises });
            if (currentDay) {
                showDay(currentDay);
            }
        }


        // Add/Edit exercise
        function showAddExerciseModal() {
            document.getElementById('exercise-modal-container').innerHTML = `
                <div class="bg-white p-6 rounded-3xl shadow-lg max-w-lg w-full scrollable-modal-content">
                    <h3 class="text-xl font-bold mb-4">Agregar Ejercicio</h3>
                    <div class="space-y-4">
                        <label class="block">
                            <span class="text-sm font-semibold">Nombre del ejercicio:</span>
                            <input type="text" id="exercise-name" placeholder="Ej: Hip thrust" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Series:</span>
                            <input type="number" id="exercise-series" placeholder="Ej: 4" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Repeticiones:</span>
                            <input type="number" id="exercise-reps" placeholder="Ej: 8" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Peso (kg):</span>
                            <input type="number" id="exercise-weight" placeholder="Ej: 50" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Descripción (Qué trabaja):</span>
                            <textarea id="exercise-description" placeholder="Ej: Este ejercicio trabaja los glúteos y los isquiotibiales." class="w-full p-2 rounded-lg border mt-1 h-24"></textarea>
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Cómo hacerlo:</span>
                            <textarea id="exercise-howto" placeholder="Ej: Apoya la parte superior de la espalda en un banco..." class="w-full p-2 rounded-lg border mt-1 h-24"></textarea>
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Subir imagen:</span>
                            <input type="file" id="exercise-image" accept="image/*" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        <div class="flex justify-end space-x-2 mt-4">
                            <button onclick="closeModal('exercise-modal-container')" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-full">Cancelar</button>
                            <button onclick="saveExercise()" class="bg-blue-400 text-white py-2 px-4 rounded-full">Guardar</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('exercise-modal-container').classList.remove('hidden');
            document.getElementById('exercise-modal-container').classList.add('flex');
        }

        function showEditExerciseModal(day, index) {
            const exercise = userData.exercises[day][index];
            document.getElementById('exercise-modal-container').innerHTML = `
                <div class="bg-white p-6 rounded-3xl shadow-lg max-w-lg w-full scrollable-modal-content">
                    <h3 class="text-xl font-bold mb-4">Editar Ejercicio</h3>
                    <div class="space-y-4">
                        <label class="block">
                            <span class="text-sm font-semibold">Nombre del ejercicio:</span>
                            <input type="text" id="exercise-name" value="${exercise.name}" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Series:</span>
                            <input type="number" id="exercise-series" value="${exercise.series}" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Repeticiones:</span>
                            <input type="number" id="exercise-reps" value="${exercise.reps}" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Peso (kg):</span>
                            <input type="number" id="exercise-weight" value="${exercise.weight || 0}" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Descripción (Qué trabaja):</span>
                            <textarea id="exercise-description" class="w-full p-2 rounded-lg border mt-1 h-24">${exercise.description}</textarea>
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Cómo hacerlo:</span>
                            <textarea id="exercise-howto" class="w-full p-2 rounded-lg border mt-1 h-24">${exercise.howTo}</textarea>
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Subir nueva imagen:</span>
                            <input type="file" id="exercise-image" accept="image/*" class="w-full p-2 rounded-lg border mt-1">
                        </label>
                        ${exercise.image ? `<div class="mt-4"><span class="text-sm font-semibold">Imagen actual:</span><br><img src="${exercise.image}" class="mt-2 rounded-lg cursor-pointer w-full object-cover" onclick="openModal('${exercise.image}')"></div>` : ''}
                        <div class="flex justify-between space-x-2 mt-4">
                            <button onclick="showConfirmationModal('¿Estás seguro que quieres eliminar este ejercicio?', () => deleteExercise('${day}', ${index}))" class="bg-red-400 text-white py-2 px-4 rounded-full">Eliminar</button>
                            <div class="flex space-x-2">
                                <button onclick="closeModal('exercise-modal-container')" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-full">Cancelar</button>
                                <button onclick="saveExercise('${day}', ${index})" class="bg-blue-400 text-white py-2 px-4 rounded-full">Guardar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('exercise-modal-container').classList.remove('hidden');
            document.getElementById('exercise-modal-container').classList.add('flex');
        }

        async function saveExercise(day, index = null) {
            const name = document.getElementById('exercise-name').value;
            const series = parseInt(document.getElementById('exercise-series').value, 10);
            const reps = parseInt(document.getElementById('exercise-reps').value, 10);
            const weight = parseInt(document.getElementById('exercise-weight').value, 10);
            const description = document.getElementById('exercise-description').value;
            const howTo = document.getElementById('exercise-howto').value;
            const imageFile = document.getElementById('exercise-image').files[0];

            if (!name || isNaN(series) || isNaN(reps)) {
                alert('Por favor, completa los campos requeridos.');
                return;
            }

            let imageUrl = '';
            if (imageFile) {
                imageUrl = await toBase64(imageFile);
            }

            const newExercise = {
                name,
                series,
                reps,
                weight,
                description,
                howTo,
                image: imageUrl,
                status: 0
            };

            if (index !== null) {
                // Edit existing exercise
                userData.exercises[day][index] = { ...userData.exercises[day][index], ...newExercise };
            } else {
                // Add new exercise
                userData.exercises[currentDay].push(newExercise);
            }
            
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/privateData`, "data");
            await updateDoc(userDocRef, { exercises: userData.exercises });
            closeModal('exercise-modal-container');
            showDay(currentDay);
        }

        function openModal(imageSrc) {
            const modalImage = document.getElementById('modal-image-src');
            modalImage.src = imageSrc;
            document.getElementById('image-modal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showConfirmationModal(message, onConfirm) {
            document.getElementById('modal-container').innerHTML = `
                <div class="bg-white p-6 rounded-3xl shadow-lg max-w-sm text-center">
                    <p class="text-lg font-semibold mb-4">${message}</p>
                    <div class="flex justify-center space-x-4">
                        <button onclick="closeModal('modal-container')" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-full">Cancelar</button>
                        <button onclick="window.confirmAction = true; closeModal('modal-container');" class="bg-red-400 text-white py-2 px-4 rounded-full">Confirmar</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
            document.getElementById('modal-container').classList.add('flex');
            
            const confirmButton = document.querySelector('#modal-container button.bg-red-400');
            confirmButton.onclick = () => {
                onConfirm();
                closeModal('modal-container');
            };
        }

        async function deleteExercise(day, index) {
            const exerciseName = userData.exercises[day][index].name;
            userData.exercises[day].splice(index, 1);

            // Remove from history if it exists there
            const historyKeys = Object.keys(userData.history || {});
            const keyToRemove = historyKeys.find(key => userData.history[key].day === day && userData.history[key].name === exerciseName);
            if (keyToRemove) {
                delete userData.history[keyToRemove];
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/privateData`, "data");
            await updateDoc(userDocRef, {
                exercises: userData.exercises,
                history: userData.history
            });

            closeModal('exercise-modal-container');
            showDay(day);
        }

        function renderHistory() {
            const historyList = document.getElementById('historial-list');
            historyList.innerHTML = '';
            const history = userData?.history || {};
            const historyKeys = Object.keys(history).sort((a, b) => new Date(history[b].date) - new Date(history[a].date));
            
            if (historyKeys.length === 0) {
                historyList.innerHTML = `<p class="text-center text-gray-500">No hay ejercicios completados en el historial.</p>`;
                return;
            }

            historyKeys.forEach(key => {
                const item = history[key];
                const itemDiv = document.createElement('div');
                itemDiv.className = `bg-white p-4 rounded-xl shadow-lg`;
                const date = new Date(item.date).toLocaleString('es-ES');
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-bold text-gray-800">${item.name}</h4>
                        <button onclick="showConfirmationModal('¿Estás seguro que quieres eliminar este ejercicio del historial?', () => deleteHistoryItem('${key}'))" class="bg-red-400 text-white py-1 px-3 rounded-full hover:bg-red-500 transition-colors">Eliminar</button>
                    </div>
                    <p class="mt-2 text-sm text-gray-600"><strong>Día:</strong> ${item.day}</p>
                    <p class="text-sm text-gray-600"><strong>Fecha:</strong> ${date}</p>
                    <p class="text-sm text-gray-600"><strong>Peso:</strong> ${item.weight || 0} kg</p>
                `;
                historyList.appendChild(itemDiv);
            });
        }

        async function deleteHistoryItem(key) {
            delete userData.history[key];
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/privateData`, "data");
            await updateDoc(userDocRef, { history: userData.history });
        }

        function showResetSummary() {
            if (!userData || !userData.exercises) return;

            const missedExercises = [];
            weekDays.forEach(day => {
                const exercisesForDay = userData.exercises[day].filter(e => e.status === 1); // Status 1 is for 'missed'
                exercisesForDay.forEach(exercise => {
                    missedExercises.push({ ...exercise, day });
                });
            });

            const modalContent = document.getElementById('modal-container');
            let contentHtml = `
                <div class="bg-white p-6 rounded-3xl shadow-lg max-w-xl w-full scrollable-modal-content">
                    <h3 class="text-xl font-bold mb-4 text-center">Resumen Semanal de Ejercicios Pendientes</h3>
                    ${missedExercises.length > 0 ? '' : '<p class="text-center text-gray-500">¡Felicidades! No tienes ejercicios pendientes esta semana.</p>'}
                    <div class="space-y-4">
            `;

            missedExercises.forEach(ex => {
                contentHtml += `
                    <div class="bg-rose-100 p-4 rounded-xl shadow-md">
                        <h4 class="text-lg font-semibold text-rose-800">${ex.name}</h4>
                        <p class="text-sm text-gray-700"><b>Día:</b> ${ex.day}</p>
                        <p class="text-sm text-gray-700"><b>Qué trabaja:</b> ${ex.description}</p>
                    </div>
                `;
            });
            
            contentHtml += `
                    </div>
                    <div class="flex justify-end space-x-4 mt-4">
                        <button onclick="closeModal('modal-container')" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-full">Cerrar</button>
                        <button onclick="resetWeek(); closeModal('modal-container');" class="bg-rose-400 text-white py-2 px-4 rounded-full">Restablecer la semana</button>
                    </div>
                </div>
            `;
            
            modalContent.innerHTML = contentHtml;
            modalContent.classList.remove('hidden');
            modalContent.classList.add('flex');
        }

        // Calculates and displays weekly progress
        function calculateWeeklyProgress() {
            const weeklyProgressContainer = document.getElementById('weekly-progress-container');
            const weeklyProgressBar = document.getElementById('weekly-progress-bar');
            const weeklyProgressMessage = document.getElementById('weekly-progress-message');

            if (!userData || !userData.exercises) {
                weeklyProgressContainer.classList.add('hidden');
                return;
            }

            let totalExercises = 0;
            let completedExercises = 0;

            weekDays.forEach(day => {
                if (userData.exercises[day]) {
                    totalExercises += userData.exercises[day].length;
                    completedExercises += userData.exercises[day].filter(e => e.status !== 0).length;
                }
            });

            if (totalExercises > 0) {
                const progress = (completedExercises / totalExercises) * 100;
                weeklyProgressBar.style.width = `${progress}%`;
                weeklyProgressMessage.textContent = `Has completado el ${progress.toFixed(0)}% de tu semana.`;
                weeklyProgressContainer.classList.remove('hidden');
            } else {
                weeklyProgressContainer.classList.add('hidden');
            }
        }


        // Event listener for the menu toggle button
        document.getElementById('menu-toggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });

        window.addEventListener('load', () => {
            initializeAppAndAuth();
            changeView('miInformacion'); // Start on the Mi Información page
        });
    </script>
</body>
</html>
